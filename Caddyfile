{
  email {env.ACME_EMAIL}
  admin off
}

{env.DOMAIN} {
  encode gzip zstd
  @api path /api/* /docs /openapi.json /ping /healthz /metrics /register /login /consent/* /delete_session/* /upload /fine_tune_bio/* /preprocess_photo/* /session/* /generate_avatar/* /validate_d_id_key /clone_voice/* /generate_speech/* /validate_elevenlabs_key /voice_info/* /process_text/* /fine_tune_conversation/* /generate_conversation/* /conversation_model_info/* /interact/* /interaction_history/* /session_status/*
  handle @api {
    reverse_proxy backend:8000
  }

  handle {
    reverse_proxy frontend:8080
  }

  # Optional: expose Grafana at /grafana (uncomment if needed and secure!)
  # handle_path /grafana* {
  #   reverse_proxy grafana:3000
  # }

  header /* {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "no-referrer"
    Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;"
  }

  tls {
    on_demand
  }
}

:80 {
  redir https://{env.DOMAIN}{uri}
}